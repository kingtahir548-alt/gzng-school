<!DOCTYPE html>
<html lang="ku" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø³ÛŒØ³ØªÛ•Ù…ÛŒ Ú†Ø§Ù„Ø§Ú©ÛŒÛ•Ú©Ø§Ù†ÛŒ Ù‚ÙˆØªØ§Ø¨Ø®Ø§Ù†Û•ÛŒ Ú¯Ø²Ù†Ú¯</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@300;400;700;900&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Noto Sans Arabic', 'sans-serif'],
                    },
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#8b5cf6',
                        dark: '#0f172a',
                    }
                }
            }
        }
    </script>
    <style>
        body { 
            font-family: 'Noto Sans Arabic', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }

        /* Custom Classes */
        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        .dark .glass-panel {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .input-animate {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .input-animate:focus {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.15);
        }

        /* A4 Paper Logic */
        .a4-wrapper {
            width: 210mm;
            min-height: 297mm;
            background: white;
            margin: 0 auto;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            position: relative;
            transform-origin: top center;
        }

        @media print {
            body * { visibility: hidden; }
            #reportModal, #reportModal * { visibility: visible; }
            #reportModal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; padding: 0; }
            .a4-wrapper { box-shadow: none; margin: 0; width: 100%; transform: none !important; }
            .no-print { display: none !important; }
        }

        /* Animation */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-enter { animation: fadeIn 0.4s ease-out forwards; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 transition-colors duration-300 min-h-screen pb-10 selection:bg-blue-200 selection:text-blue-900">

    <div id="app" class="w-full relative z-10"></div>

    <div id="statusBar" class="fixed top-4 right-4 z-50 px-4 py-2 rounded-full text-xs font-bold shadow-lg hidden transition-all duration-300 transform translate-y-0"></div>

    <div id="loadingOverlay" class="hidden fixed inset-0 bg-white/80 backdrop-blur-sm z-[9999] flex flex-col items-center justify-center transition-all duration-300">
        <div class="relative w-16 h-16">
            <div class="absolute inset-0 border-4 border-blue-100 rounded-full"></div>
            <div class="absolute inset-0 border-4 border-blue-600 rounded-full border-t-transparent animate-spin"></div>
        </div>
        <p class="mt-4 text-blue-900 font-bold animate-pulse">ØªÚ©Ø§ÛŒÛ• Ú†Ø§ÙˆÛ•Ú•ÛØ¨Û•...</p>
    </div>

    <div id="notification" class="hidden fixed top-6 left-1/2 transform -translate-x-1/2 bg-white px-6 py-4 rounded-2xl shadow-2xl z-[1000] flex items-center gap-4 min-w-[320px] border-r-4 border-green-500 animate-enter">
        <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center text-green-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
        </div>
        <div>
            <h3 class="font-bold text-gray-900" id="notifTitle">Ø³Û•Ø±Ú©Û•ÙˆØªÙˆÙˆ Ø¨ÙˆÙˆ</h3>
            <p class="text-sm text-gray-500" id="notifText">Ú©Ø±Ø¯Ø§Ø±Û•Ú©Û• Ø¦Û•Ù†Ø¬Ø§Ù…Ø¯Ø±Ø§.</p>
        </div>
    </div>

    <script>
        // CONFIG
        const LOGO_URL = 'https://cdn-icons-png.flaticon.com/512/3209/3209265.png'; // ÙˆÛÙ†Û•ÛŒÛ•Ú©ÛŒ Ú©Ø§ØªÛŒØŒ Ø¯Û•ØªÙˆØ§Ù†ÛŒØª Ø¨ÛŒÚ¯Û†Ú•ÛŒØª
        const API_URL = 'https://script.google.com/macros/s/AKfycbzBU_aPa1OnUPKiZ5XX0yK9b_tTl2UjGCr4-JzC6fqHfJvJ9OWQcVlnYur1FPgDpBt18A/exec';
        // Changed back to your original key to restore data
        const STORAGE_KEY = 'gzng-final-v30-lesson-fix';

        // STATE
        let state = {
            currentView: 'teacher',
            activities: [],
            isAdminAuthenticated: false,
            adminPassword: '',
            showMonthModal: false,
            showReportModal: false,
            reportScale: 1,
            viewDay: 'Ø´Û•Ù…Ù…Û•',
            isOnline: true,
            filterDate: new Date().toISOString().slice(0, 7),
            theme: localStorage.getItem('gzng-theme') || 'light',
            
            // Form Data (Separate from View State to prevent re-renders)
            form: { 
                teacherName: '', 
                subject: '', 
                activityName: '', 
                dayOfWeek: '', 
                lessonNumber: '', 
                date: new Date().toISOString().split('T')[0] 
            },
            
            // Login Data
            login: { username: '', password: '' },
            
            // Report Data
            report: { 
                teacherName: '', 
                activityName: '', 
                date: new Date().toISOString().split('T')[0], 
                orientation: 'landscape', 
                images: [null, null, null, null], 
                imgSettings: Array(4).fill().map(() => ({zoom: 1, x: 50, y: 50})) 
            }
        };

        // --- UTILS ---
        function toggleTheme() {
            state.theme = state.theme === 'light' ? 'dark' : 'light';
            localStorage.setItem('gzng-theme', state.theme);
            applyTheme();
        }

        function applyTheme() {
            const body = document.body;
            if (state.theme === 'dark' || state.currentView === 'admin') {
                body.classList.add('dark', 'bg-slate-900', 'text-white');
                body.classList.remove('bg-gray-100', 'text-gray-800');
            } else {
                body.classList.remove('dark', 'bg-slate-900', 'text-white');
                body.classList.add('bg-gray-100', 'text-gray-800');
            }
            // Re-render only if needed to update icons
            render();
        }

        function getLessonName(val) {
            if (!val) return 'Ø¯ÛŒØ§Ø±ÛŒ Ù†Û•Ú©Ø±Ø§ÙˆÛ•';
            const map = { '1': 'ÙˆØ§Ù†Û•ÛŒ ÛŒÛ•Ú©Û•Ù…', '2': 'ÙˆØ§Ù†Û•ÛŒ Ø¯ÙˆÙˆÛ•Ù…', '3': 'ÙˆØ§Ù†Û•ÛŒ Ø³ÛÛŒÛ•Ù…', '4': 'ÙˆØ§Ù†Û•ÛŒ Ú†ÙˆØ§Ø±Û•Ù…', '5': 'ÙˆØ§Ù†Û•ÛŒ Ù¾ÛÙ†Ø¬Û•Ù…', '6': 'ÙˆØ§Ù†Û•ÛŒ Ø´Û•Ø´Û•Ù…' };
            return map[val] || val;
        }

        function updateStatus(status) {
            const el = document.getElementById('statusBar');
            el.classList.remove('hidden', 'bg-green-100', 'text-green-700', 'bg-orange-100', 'text-orange-700');
            if(status === 'online') { 
                el.classList.add('bg-green-100', 'text-green-700'); 
                el.innerHTML = "ğŸŸ¢ Ø¦Û†Ù†Ù„Ø§ÛŒÙ†"; state.isOnline = true; 
            } else { 
                el.classList.add('bg-orange-100', 'text-orange-700'); 
                el.innerHTML = "ğŸŸ  Ù„Û†Ú©Ø§Úµ (Offline)"; state.isOnline = false; 
            }
            setTimeout(() => el.classList.add('hidden'), 4000);
        }

        function showNotification(title, msg) {
            const n = document.getElementById('notification');
            document.getElementById('notifTitle').innerText = title;
            document.getElementById('notifText').innerText = msg;
            n.classList.remove('hidden');
            setTimeout(() => n.classList.add('hidden'), 3000);
        }

        // --- DATA HANDLING ---
        async function loadActivities() {
            if (localStorage.getItem(STORAGE_KEY)) { 
                state.activities = JSON.parse(localStorage.getItem(STORAGE_KEY)); 
                render(); 
            }
            try {
                const response = await fetch(API_URL);
                if (response.ok) { 
                    const data = await response.json(); 
                    if (Array.isArray(data)) { 
                        state.activities = data; 
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); 
                        updateStatus('online'); 
                        render(); 
                    } 
                }
            } catch (error) { updateStatus('offline'); }
        }

        async function handleSubmit() {
            // Validation
            const fields = ['teacherName', 'subject', 'activityName', 'dayOfWeek', 'lessonNumber'];
            let isValid = true;
            fields.forEach(f => {
                const el = document.getElementById(f);
                if(!state.form[f]) {
                    if(el) el.classList.add('border-red-500', 'ring-2', 'ring-red-200');
                    isValid = false;
                } else {
                    if(el) el.classList.remove('border-red-500', 'ring-2', 'ring-red-200');
                }
            });

            if (!isValid) return showNotification("Ù‡Û•ÚµÛ•", "ØªÚ©Ø§ÛŒÛ• Ù‡Û•Ù…ÙˆÙˆ Ø®Ø§Ù†Û•Ú©Ø§Ù† Ù¾Ú• Ø¨Ú©Û•Ø±Û•ÙˆÛ•");

            document.getElementById('loadingOverlay').classList.remove('hidden');
            
            const newActivity = { 
                action: 'submit', 
                id: Date.now(), 
                ...state.form,
                lessonTime: state.form.lessonNumber 
            };

            const tempState = [...state.activities];
            // Optimistic UI Update
            state.activities.push(newActivity);
            render();

            try {
                const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify(newActivity) });
                const result = await response.json();
                
                if (result.result === "success") { 
                    showNotification("ØªÛ†Ù…Ø§Ø±Ú©Ø±Ø§!", "Ø¨Û• Ø³Û•Ø±Ú©Û•ÙˆØªÙˆÙˆÛŒÛŒ Ù†ÛØ±Ø¯Ø±Ø§");
                    // Clear form
                    state.form = { teacherName: '', subject: '', activityName: '', dayOfWeek: '', lessonNumber: '', date: new Date().toISOString().split('T')[0] };
                    render(); // Re-render to clear inputs
                    updateStatus('online');
                } else if (result.result === "conflict") { 
                    state.activities = tempState; 
                    alert(`âš ï¸ Ø¦Ø§Ú¯Ø§Ø¯Ø§Ø±ÛŒ!\n\nÙ„Û•Ù… Ú©Ø§ØªÛ•Ø¯Ø§ Ù…Ø§Ù…Û†Ø³ØªØ§ (${result.teacher}) Ú†Ø§Ù„Ø§Ú©ÛŒ Ù‡Û•ÛŒÛ•.`); 
                } else { 
                    state.activities = tempState; 
                    alert("Ù‡Û•ÚµÛ• Ù„Û• Ø³ÛØ±Ú¤Û•Ø±."); 
                }
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state.activities));
            } catch (e) { 
                alert("Ú©ÛØ´Û• Ù„Û• Ø¦ÛŒÙ†ØªÛ•Ø±Ù†ÛØª. Ø¯Ø§ØªØ§ Ù„Û•Ù†Ø§Ùˆ Ù…Û†Ø¨Ø§ÛŒÙ„ Ù‡Û•ÚµÚ¯ÛŒØ±Ø§."); 
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state.activities));
                updateStatus('offline'); 
            } finally { 
                document.getElementById('loadingOverlay').classList.add('hidden'); 
            }
        }

        async function handleLogin() {
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            document.getElementById('loadingOverlay').classList.remove('hidden');
            try {
                const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "login", username: u, password: p }) });
                const result = await response.json();
                if (result.result === "success") { 
                    state.isAdminAuthenticated = true; 
                    state.adminPassword = p; 
                    state.currentView = 'admin';
                    applyTheme();
                } else { 
                    alert('Ø²Ø§Ù†ÛŒØ§Ø±ÛŒ Ù‡Û•ÚµÛ•ÛŒÛ•!'); 
                }
            } catch (error) { alert("Ú©ÛØ´Û• Ù„Û• Ù¾Û•ÛŒÙˆÛ•Ø³ØªØ¨ÙˆÙˆÙ†."); } finally { document.getElementById('loadingOverlay').classList.add('hidden'); }
        }

        async function deleteActivity(id) {
            if(!confirm("Ø¯ÚµÙ†ÛŒØ§ÛŒØª Ù„Û• Ø³Ú•ÛŒÙ†Û•ÙˆÛ•ÛŒ Ø¦Û•Ù… Ú†Ø§Ù„Ø§Ú©ÛŒÛ•ØŸ")) return;
            document.getElementById('loadingOverlay').classList.remove('hidden');
            try {
                const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "delete", id: id, password: state.adminPassword }) });
                const result = await response.json();
                if (result.result === "success") {
                    state.activities = state.activities.filter(a => a.id != id);
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(state.activities));
                    render();
                    showNotification("Ø³Ú•Ø§ÛŒÛ•ÙˆÛ•", "Ú†Ø§Ù„Ø§Ú©ÛŒÛ•Ú©Û• Ø³Ú•Ø§ÛŒÛ•ÙˆÛ•");
                }
            } catch(e) { alert("Ú©ÛØ´Û• Ù‡Û•ÛŒÛ•"); } finally { document.getElementById('loadingOverlay').classList.add('hidden'); }
        }

        // --- IMAGE & DRAG LOGIC ---
        function downloadReport(id, name) {
            const el = document.getElementById(id);
            if(!el) return;
            const btn = document.activeElement;
            const oldText = btn.innerText;
            btn.innerText = '...';
            
            html2canvas(el, { scale: 2, useCORS: true, backgroundColor: '#ffffff' }).then(canvas => {
                const link = document.createElement('a');
                link.download = name;
                link.href = canvas.toDataURL('image/jpeg', 0.9);
                link.click();
                btn.innerText = oldText;
            });
        }
        
        function handleImage(input, idx) {
            if(input.files[0]) {
                const r = new FileReader();
                r.onload = (e) => { 
                    state.report.images[idx] = e.target.result; 
                    state.report.imgSettings[idx] = {zoom: 1, x: 50, y: 50};
                    render();
                };
                r.readAsDataURL(input.files[0]);
            }
        }

        // --- RENDER COMPONENTS ---

        function Header() {
            const isDark = state.theme === 'dark';
            return `
            <div class="relative overflow-hidden bg-gradient-to-r from-blue-600 to-indigo-700 text-white pb-16 rounded-b-[2.5rem] shadow-2xl mb-[-40px]">
                <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10"></div>
                <div class="max-w-6xl mx-auto px-6 py-8 relative z-10">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="w-16 h-16 bg-white/20 backdrop-blur rounded-2xl flex items-center justify-center border border-white/20 shadow-inner">
                                <span class="text-3xl">ğŸ“</span>
                            </div>
                            <div>
                                <h1 class="text-2xl md:text-3xl font-black tracking-tight">Ù‚ÙˆØªØ§Ø¨Ø®Ø§Ù†Û•ÛŒ Ú¯Ø²Ù†Ú¯</h1>
                                <p class="text-blue-100 text-sm font-medium opacity-90">Ø³ÛŒØ³ØªÛ•Ù…ÛŒ Ø¨Û•Ú•ÛÙˆÛ•Ø¨Ø±Ø¯Ù†ÛŒ Ú†Ø§Ù„Ø§Ú©ÛŒÛ•Ú©Ø§Ù†</p>
                            </div>
                        </div>
                        <div class="flex gap-3">
                            ${state.currentView === 'teacher' ? `
                            <button onclick="toggleTheme()" class="w-10 h-10 rounded-xl bg-white/10 hover:bg-white/20 flex items-center justify-center backdrop-blur transition border border-white/10">
                                ${isDark ? 'â˜€ï¸' : 'ğŸŒ™'}
                            </button>` : ''}
                            ${state.isAdminAuthenticated ? `<button onclick="state.isAdminAuthenticated=false; state.currentView='teacher'; applyTheme();" class="bg-red-500/80 hover:bg-red-600 px-4 py-2 rounded-xl text-sm font-bold backdrop-blur transition">Ø¯Û•Ø±Ú†ÙˆÙˆÙ†</button>` : ''}
                        </div>
                    </div>
                </div>
            </div>`;
        }

        function Navigation() {
            const activeClass = "bg-blue-600 text-white shadow-lg shadow-blue-500/30 scale-105";
            const inactiveClass = "bg-white text-gray-600 hover:bg-gray-50 dark:bg-slate-800 dark:text-gray-300 dark:hover:bg-slate-700";
            
            return `
            <div class="max-w-4xl mx-auto px-4 relative z-20 mb-8">
                <div class="bg-white/80 dark:bg-slate-800/80 backdrop-blur-md p-2 rounded-2xl shadow-xl border border-white/20 flex justify-center gap-2">
                    <button onclick="state.currentView='teacher'; applyTheme();" class="flex-1 py-3 rounded-xl font-bold text-sm transition-all duration-300 ${state.currentView === 'teacher' ? activeClass : inactiveClass}">Ù¾Û•Ù†ÛÚµÛŒ Ù…Ø§Ù…Û†Ø³ØªØ§</button>
                    <button onclick="state.currentView='admin'; applyTheme();" class="flex-1 py-3 rounded-xl font-bold text-sm transition-all duration-300 ${state.currentView === 'admin' ? activeClass : inactiveClass}">Ù¾Û•Ù†ÛÚµÛŒ Ø¦Û•Ø¯Ù…ÛŒÙ†</button>
                    <button onclick="window.open('https://gzng-archive.vercel.app/', '_blank')" class="flex-1 py-3 rounded-xl font-bold text-sm transition-all duration-300 ${inactiveClass}">ğŸ“‚ Ø¦Û•Ø±Ø´ÛŒÙ</button>
                </div>
            </div>`;
        }

        function TeacherView() {
            const days = ['Ø´Û•Ù…Ù…Û•', 'ÛŒÛ•Ú©Ø´Û•Ù…Ù…Û•', 'Ø¯ÙˆÙˆØ´Û•Ù…Ù…Û•', 'Ø³ÛØ´Û•Ù…Ù…Û•', 'Ú†ÙˆØ§Ø±Ø´Û•Ù…Ù…Û•', 'Ù¾ÛÙ†Ø¬Ø´Û•Ù…Ù…Û•', 'Ù‡Û•ÛŒÙ†ÛŒ'];
            const lessons = ['ÙˆØ§Ù†Û•ÛŒ ÛŒÛ•Ú©Û•Ù…', 'ÙˆØ§Ù†Û•ÛŒ Ø¯ÙˆÙˆÛ•Ù…', 'ÙˆØ§Ù†Û•ÛŒ Ø³ÛÛŒÛ•Ù…', 'ÙˆØ§Ù†Û•ÛŒ Ú†ÙˆØ§Ø±Û•Ù…', 'ÙˆØ§Ù†Û•ÛŒ Ù¾ÛÙ†Ø¬Û•Ù…', 'ÙˆØ§Ù†Û•ÛŒ Ø´Û•Ø´Û•Ù…'];
            
            const dailyActs = state.activities.filter(a => a.dayOfWeek === state.viewDay);

            return `
            <div class="max-w-6xl mx-auto px-4 grid grid-cols-1 md:grid-cols-12 gap-6 animate-enter">
                <div class="md:col-span-5 lg:col-span-4">
                    <div class="glass-panel p-6 rounded-3xl sticky top-4">
                        <h3 class="font-bold text-xl mb-6 flex items-center gap-2 dark:text-white">
                            <span class="w-8 h-8 rounded-lg bg-blue-100 text-blue-600 flex items-center justify-center text-lg">ğŸ“</span>
                            ØªÛ†Ù…Ø§Ø±Ú©Ø±Ø¯Ù†
                        </h3>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1 dark:text-gray-400">Ù†Ø§ÙˆÛŒ Ù…Ø§Ù…Û†Ø³ØªØ§</label>
                                <input type="text" id="teacherName" value="${state.form.teacherName}" oninput="state.form.teacherName = this.value" class="input-animate w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 font-bold focus:outline-none focus:border-blue-500 dark:bg-slate-700 dark:border-slate-600 dark:text-white" placeholder="Ù†Ø§ÙˆÛŒ Ø³ÛŒØ§Ù†ÛŒ...">
                            </div>

                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 mb-1 dark:text-gray-400">Ú•Û†Ú˜</label>
                                    <select id="dayOfWeek" onchange="state.form.dayOfWeek = this.value" class="input-animate w-full bg-gray-50 border border-gray-200 rounded-xl px-2 py-3 font-bold focus:outline-none focus:border-blue-500 dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                                        <option value="">Ø¯ÛŒØ§Ø±ÛŒØ¨Ú©Û•</option>
                                        ${days.map(d => `<option value="${d}" ${state.form.dayOfWeek === d ? 'selected' : ''}>${d}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 mb-1 dark:text-gray-400">ÙˆØ§Ù†Û•</label>
                                    <select id="lessonNumber" onchange="state.form.lessonNumber = this.value" class="input-animate w-full bg-gray-50 border border-gray-200 rounded-xl px-2 py-3 font-bold focus:outline-none focus:border-blue-500 dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                                        <option value="">Ø¯ÛŒØ§Ø±ÛŒØ¨Ú©Û•</option>
                                        ${lessons.map(l => `<option value="${l}" ${state.form.lessonNumber === l ? 'selected' : ''}>${l}</option>`).join('')}
                                    </select>
                                </div>
                            </div>

                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1 dark:text-gray-400">Ø¨Ø§Ø¨Û•Øª</label>
                                <input type="text" id="subject" value="${state.form.subject}" oninput="state.form.subject = this.value" class="input-animate w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 font-bold focus:outline-none focus:border-blue-500 dark:bg-slate-700 dark:border-slate-600 dark:text-white" placeholder="Ù†Ù…ÙˆÙˆÙ†Û•: Ø¨ÛŒØ±Ú©Ø§Ø±ÛŒ">
                            </div>

                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1 dark:text-gray-400">Ø¬Û†Ø±ÛŒ Ú†Ø§Ù„Ø§Ú©ÛŒ</label>
                                <input type="text" id="activityName" value="${state.form.activityName}" oninput="state.form.activityName = this.value" class="input-animate w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 font-bold focus:outline-none focus:border-blue-500 dark:bg-slate-700 dark:border-slate-600 dark:text-white" placeholder="Ù†Ù…ÙˆÙˆÙ†Û•: ØªØ§Ù‚ÛŒÚ©Ø±Ø¯Ù†Û•ÙˆÛ•ÛŒ Ú•Û†Ú˜Ø§Ù†Û•">
                            </div>

                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1 dark:text-gray-400">Ø¨Û•Ø±ÙˆØ§Ø±</label>
                                <input type="date" id="date" value="${state.form.date}" oninput="state.form.date = this.value" class="input-animate w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 font-bold focus:outline-none focus:border-blue-500 dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                            </div>

                            <button onclick="handleSubmit()" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-black py-4 rounded-xl shadow-lg hover:shadow-xl hover:-translate-y-1 transition-all active:scale-95 mt-2">ØªÛ†Ù…Ø§Ø±Ú©Ø±Ø¯Ù†ÛŒ Ú†Ø§Ù„Ø§Ú©ÛŒ</button>
                        </div>
                    </div>
                </div>

                <div class="md:col-span-7 lg:col-span-8">
                    <div class="glass-panel p-6 rounded-3xl min-h-[500px]">
                         <div class="flex items-center justify-between mb-6 border-b border-gray-200 pb-4 dark:border-gray-700">
                             <h3 class="font-bold text-xl dark:text-white">Ø®Ø´ØªÛ•ÛŒ Ú†Ø§Ù„Ø§Ú©ÛŒÛ•Ú©Ø§Ù†</h3>
                             <span class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-xs font-bold">${state.viewDay}</span>
                         </div>

                         <div class="flex gap-2 overflow-x-auto pb-2 no-scrollbar mb-4">
                            ${days.map(d => `<button onclick="state.viewDay='${d}'; render()" class="px-4 py-2 rounded-xl text-sm font-bold whitespace-nowrap transition-all ${state.viewDay === d ? 'bg-blue-600 text-white shadow-md' : 'bg-gray-100 text-gray-500 hover:bg-gray-200 dark:bg-slate-700 dark:text-gray-400'}">${d}</button>`).join('')}
                         </div>

                         <div class="space-y-3 h-[500px] overflow-y-auto pr-2">
                            ${dailyActs.length === 0 ? 
                            `<div class="flex flex-col items-center justify-center h-full text-gray-400 opacity-60">
                                <span class="text-4xl mb-2">ğŸ“­</span>
                                <p class="font-bold">Ù‡ÛŒÚ† Ú†Ø§Ù„Ø§Ú©ÛŒÛ•Ú© Ù†ÛŒÛŒÛ•</p>
                            </div>` : 
                            dailyActs.map(act => `
                                <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex items-center justify-between hover:shadow-md transition-all group dark:bg-slate-800 dark:border-slate-700">
                                    <div class="flex items-center gap-4">
                                        <div class="w-12 h-12 rounded-2xl bg-indigo-50 text-indigo-600 flex items-center justify-center font-black text-lg border border-indigo-100 dark:bg-slate-700 dark:text-indigo-400 dark:border-slate-600">
                                            ${act.lessonTime || '?'}
                                        </div>
                                        <div>
                                            <h4 class="font-bold text-gray-800 dark:text-gray-200">${act.teacherName}</h4>
                                            <div class="flex items-center gap-2 text-xs text-gray-500 mt-1 dark:text-gray-400">
                                                <span class="font-bold text-blue-500">${act.subject}</span>
                                                <span>â€¢</span>
                                                <span>${act.activityName}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="text-xs font-bold text-gray-400 bg-gray-50 px-2 py-1 rounded-lg dark:bg-slate-700">${act.date}</div>
                                </div>
                            `).join('')}
                         </div>
                    </div>
                </div>
            </div>`;
        }

        function AdminView() {
            if (!state.isAdminAuthenticated) {
                return `
                <div class="flex items-center justify-center min-h-[500px]">
                    <div class="w-full max-w-sm glass-panel p-8 rounded-3xl text-center">
                        <div class="w-20 h-20 bg-slate-800 rounded-full mx-auto mb-6 flex items-center justify-center text-4xl shadow-lg border-4 border-slate-700">ğŸ”’</div>
                        <h2 class="text-2xl font-black text-white mb-6">Ù†Ø§ÙˆÚ†Û•ÛŒ Ø¦Û•Ø¯Ù…ÛŒÙ†</h2>
                        <div class="space-y-4">
                            <input type="text" id="username" placeholder="Ù†Ø§ÙˆÛŒ Ø¨Û•Ú©Ø§Ø±Ù‡ÛÙ†Û•Ø±" class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-center text-white font-bold outline-none focus:border-blue-500 transition">
                            <input type="password" id="password" placeholder="ÙˆØ´Û•ÛŒ Ù†Ù‡ÛÙ†ÛŒ" class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-center text-white font-bold outline-none focus:border-blue-500 transition">
                            <button onclick="handleLogin()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-black py-4 rounded-xl shadow-lg shadow-blue-600/30 transition transform active:scale-95">Ú†ÙˆÙˆÙ†Û•Ú˜ÙˆÙˆØ±Û•ÙˆÛ•</button>
                        </div>
                    </div>
                </div>`;
            }

            // Authenticated Admin View
            const sorted = [...state.activities].sort((a,b) => new Date(b.date) - new Date(a.date));
            
            return `
            <div class="max-w-6xl mx-auto px-4 pb-20 animate-enter">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                    <button onclick="state.showReportModal=true; render()" class="group bg-slate-800 p-6 rounded-3xl border border-slate-700 hover:border-blue-500 transition-all text-right relative overflow-hidden">
                        <div class="absolute right-0 top-0 w-32 h-32 bg-blue-500/10 rounded-full blur-2xl group-hover:bg-blue-500/20 transition"></div>
                        <div class="relative z-10">
                            <span class="text-3xl mb-2 block">ğŸ“¸</span>
                            <h3 class="text-xl font-bold text-white">Ú•Ø§Ù¾Û†Ø±ØªÛŒ ÙˆÛÙ†Û•ÛŒÛŒ</h3>
                            <p class="text-slate-400 text-sm">Ø¯Ø±ÙˆØ³ØªÚ©Ø±Ø¯Ù†ÛŒ Ú•Ø§Ù¾Û†Ø±Øª Ø¨Û† Ú†Ø§Ù„Ø§Ú©ÛŒÛ•Ú©Ø§Ù†</p>
                        </div>
                    </button>
                    <button onclick="state.showMonthModal=true; render()" class="group bg-slate-800 p-6 rounded-3xl border border-slate-700 hover:border-purple-500 transition-all text-right relative overflow-hidden">
                        <div class="absolute right-0 top-0 w-32 h-32 bg-purple-500/10 rounded-full blur-2xl group-hover:bg-purple-500/20 transition"></div>
                        <div class="relative z-10">
                            <span class="text-3xl mb-2 block">ğŸ“…</span>
                            <h3 class="text-xl font-bold text-white">Ø®Ø´ØªÛ•ÛŒ Ù…Ø§Ù†Ú¯Ø§Ù†Û•</h3>
                            <p class="text-slate-400 text-sm">Ø¨ÛŒÙ†ÛŒÙ†ÛŒ Ù„ÛŒØ³ØªÛŒ Ú†Ø§Ù„Ø§Ú©ÛŒÛ•Ú©Ø§Ù†ÛŒ Ù…Ø§Ù†Ú¯</p>
                        </div>
                    </button>
                </div>

                <div class="bg-slate-800 rounded-3xl border border-slate-700 overflow-hidden">
                    <div class="p-6 border-b border-slate-700 flex justify-between items-center">
                        <h3 class="font-bold text-white text-lg">Ù‡Û•Ù…ÙˆÙˆ Ú†Ø§Ù„Ø§Ú©ÛŒÛ•Ú©Ø§Ù† (${sorted.length})</h3>
                        <input type="text" placeholder="Ú¯Û•Ú•Ø§Ù†..." oninput="/* Implement search if needed */" class="bg-slate-900 border border-slate-700 rounded-lg px-3 py-1 text-sm text-white focus:outline-none">
                    </div>
                    <div class="divide-y divide-slate-700">
                        ${sorted.map(a => `
                            <div class="p-4 flex items-center justify-between hover:bg-slate-700/50 transition">
                                <div class="flex items-center gap-4">
                                    <div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center text-lg shadow-inner">ğŸ‘¤</div>
                                    <div>
                                        <h4 class="font-bold text-white">${a.teacherName}</h4>
                                        <p class="text-xs text-slate-400">${a.subject} | ${a.activityName}</p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-4">
                                    <div class="text-right hidden md:block">
                                        <div class="text-xs font-bold text-blue-400">${a.dayOfWeek}</div>
                                        <div class="text-xs text-slate-500">${a.date}</div>
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="openReportFor(${a.id})" class="p-2 rounded-lg bg-blue-500/10 text-blue-400 hover:bg-blue-500 hover:text-white transition"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg></button>
                                        <button onclick="deleteActivity(${a.id})" class="p-2 rounded-lg bg-red-500/10 text-red-400 hover:bg-red-500 hover:text-white transition"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>`;
        }

        function openReportFor(id) {
            const act = state.activities.find(a => a.id == id);
            if(act) { 
                state.report.teacherName = act.teacherName; 
                state.report.activityName = act.activityName; 
                state.report.date = act.date; 
                state.showReportModal = true; 
                render(); 
            }
        }

        // --- REPORT MODAL ---
        function ReportModal() {
            return `
            <div id="reportModal" class="fixed inset-0 bg-slate-900/95 z-50 overflow-y-auto backdrop-blur-sm">
                <div class="min-h-screen py-10 flex justify-center">
                    <div class="w-full max-w-[230mm]">
                        <div class="bg-white p-4 rounded-xl shadow-lg mb-6 flex flex-wrap gap-4 justify-between items-center mx-4 no-print">
                            <h3 class="font-bold text-gray-800">Ú•ÛÚ©Ø®Ø³ØªÙ†ÛŒ Ú•Ø§Ù¾Û†Ø±Øª</h3>
                            <div class="flex gap-2">
                                <button onclick="downloadReport('report-content', 'Activity-Report.jpg')" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-blue-700 transition">Ø¯Ø§Ø¨Û•Ø²Ø§Ù†Ø¯Ù† (JPG)</button>
                                <button onclick="state.showReportModal=false; render()" class="bg-gray-100 text-gray-600 px-6 py-2 rounded-lg font-bold hover:bg-gray-200 transition">Ø¯Ø§Ø®Ø³ØªÙ†</button>
                            </div>
                        </div>

                        <div class="a4-wrapper" id="report-content">
                            <div class="p-[15mm] h-full flex flex-col relative text-right" dir="rtl">
                                <div class="flex justify-between items-center border-b-4 border-blue-600 pb-6 mb-8">
                                    <div class="w-24 h-24 bg-gray-50 rounded-xl border border-gray-100 p-2 flex items-center justify-center">
                                        <img src="${LOGO_URL}" class="w-full h-full object-contain">
                                    </div>
                                    <div class="text-center">
                                        <h1 class="text-4xl font-black text-gray-900 mb-2">Ù‚ÙˆØªØ§Ø¨Ø®Ø§Ù†Û•ÛŒ Ú¯Ø²Ù†Ú¯</h1>
                                        <h2 class="text-xl text-blue-600 font-bold tracking-wide">Ú•Ø§Ù¾Û†Ø±ØªÛŒ Ú†Ø§Ù„Ø§Ú©ÛŒ</h2>
                                    </div>
                                    <div class="text-left text-sm text-gray-600 space-y-1 font-medium">
                                        <p>Ø¨Û•Ø±ÙˆØ§Ø±: ${state.report.date}</p>
                                        <p>Ù…Ø§Ù…Û†Ø³ØªØ§: ${state.report.teacherName}</p>
                                    </div>
                                </div>

                                <div class="text-center mb-8">
                                    <input type="text" value="${state.report.activityName}" class="text-3xl font-black text-center w-full bg-transparent border-none outline-none text-gray-800 placeholder-gray-300 focus:bg-gray-50 rounded" placeholder="Ù†Ø§ÙˆÙ†ÛŒØ´Ø§Ù†ÛŒ Ú†Ø§Ù„Ø§Ú©ÛŒ...">
                                </div>

                                <div class="grid grid-cols-2 gap-4 flex-1">
                                    ${state.report.images.map((img, i) => `
                                        <div class="relative group bg-gray-100 border-2 border-dashed border-gray-300 rounded-xl overflow-hidden aspect-[4/3] flex items-center justify-center">
                                            ${img ? 
                                            `<img src="${img}" class="w-full h-full object-cover">
                                             <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 flex items-center justify-center transition no-print">
                                                 <button onclick="state.report.images[${i}]=null; render()" class="bg-red-500 text-white px-3 py-1 rounded text-sm font-bold">Ø³Ú•ÛŒÙ†Û•ÙˆÛ•</button>
                                             </div>` : 
                                            `<label class="cursor-pointer w-full h-full flex flex-col items-center justify-center text-gray-400 hover:text-blue-500 hover:bg-blue-50 transition">
                                                <span class="text-5xl mb-2">+</span>
                                                <span class="font-bold">ÙˆÛÙ†Û• Ø¯Ø§Ø¨Ù†Û</span>
                                                <input type="file" accept="image/*" class="hidden" onchange="handleImage(this, ${i})">
                                             </label>`
                                            }
                                        </div>
                                    `).join('')}
                                </div>

                                <div class="mt-auto pt-10 border-t flex justify-between text-gray-600 font-bold px-4">
                                    <span>ÙˆØ§Ú˜Û†ÛŒ Ù…Ø§Ù…Û†Ø³ØªØ§</span>
                                    <span>ÙˆØ§Ú˜Û†ÛŒ Ø¨Û•Ú•ÛÙˆÛ•Ø¨Û•Ø±</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        function MonthModal() {
            const monthlyActivities = state.activities.filter(a => a.date && String(a.date).includes(state.filterDate));
            const sorted = monthlyActivities.sort((a, b) => new Date(a.date) - new Date(b.date));

            return `
            <div id="reportModal" class="fixed inset-0 bg-slate-900/95 z-50 overflow-y-auto backdrop-blur-sm">
                <div class="min-h-screen py-10 flex justify-center">
                    <div class="w-full max-w-[230mm]">
                         <div class="bg-white p-4 rounded-xl shadow-lg mb-6 flex flex-wrap gap-4 justify-between items-center mx-4 no-print">
                            <div class="flex items-center gap-3">
                                <h3 class="font-bold text-gray-800">Ø®Ø´ØªÛ•ÛŒ Ù…Ø§Ù†Ú¯:</h3>
                                <input type="month" value="${state.filterDate}" onchange="state.filterDate = this.value; render()" class="border border-gray-300 rounded-lg px-2 py-1 bg-gray-50">
                            </div>
                            <div class="flex gap-2">
                                <button onclick="downloadReport('month-content', 'Month-Report.jpg')" class="bg-orange-500 text-white px-6 py-2 rounded-lg font-bold hover:bg-orange-600 transition">Ø¯Ø§Ø¨Û•Ø²Ø§Ù†Ø¯Ù† (JPG)</button>
                                <button onclick="state.showMonthModal=false; render()" class="bg-gray-100 text-gray-600 px-6 py-2 rounded-lg font-bold hover:bg-gray-200 transition">Ø¯Ø§Ø®Ø³ØªÙ†</button>
                            </div>
                        </div>

                        <div class="a4-wrapper" id="month-content">
                            <div class="p-[15mm] h-full flex flex-col relative text-right" dir="rtl">
                                 <div class="flex justify-between items-center border-b-4 border-orange-500 pb-6 mb-8">
                                    <div class="w-20 h-20 bg-gray-50 rounded-xl border border-gray-100 p-2 flex items-center justify-center">
                                        <img src="${LOGO_URL}" class="w-full h-full object-contain">
                                    </div>
                                    <div class="text-center">
                                        <h1 class="text-3xl font-black text-gray-900 mb-2">Ù‚ÙˆØªØ§Ø¨Ø®Ø§Ù†Û•ÛŒ Ú¯Ø²Ù†Ú¯</h1>
                                        <h2 class="text-xl text-orange-600 font-bold">Ø±Ø§Ù¾Û†Ø±ØªÛŒ Ù…Ø§Ù†Ú¯Ø§Ù†Û•</h2>
                                    </div>
                                    <div class="text-left font-bold text-gray-600">${state.filterDate}</div>
                                </div>

                                ${sorted.length === 0 ? 
                                `<div class="text-center py-20 border-2 border-dashed rounded-xl bg-gray-50 text-gray-400 font-bold text-xl">Ù‡ÛŒÚ† Ø¯Ø§ØªØ§ÛŒÛ•Ú© Ù†ÛŒÛŒÛ•</div>` : 
                                `<table class="w-full border-collapse">
                                    <thead>
                                        <tr class="bg-orange-50 text-orange-800">
                                            <th class="border p-2 text-center text-sm">#</th>
                                            <th class="border p-2 text-right text-sm">Ù…Ø§Ù…Û†Ø³ØªØ§</th>
                                            <th class="border p-2 text-center text-sm">Ú•Û†Ú˜</th>
                                            <th class="border p-2 text-center text-sm">Ø¨Û•Ø±ÙˆØ§Ø±</th>
                                            <th class="border p-2 text-center text-sm">ÙˆØ§Ù†Û•</th>
                                            <th class="border p-2 text-right text-sm">Ø¨Ø§Ø¨Û•Øª</th>
                                            <th class="border p-2 text-right text-sm">Ø¬Û†Ø±ÛŒ Ú†Ø§Ù„Ø§Ú©ÛŒ</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${sorted.map((a, i) => `
                                            <tr class="${i%2===0 ? 'bg-white' : 'bg-gray-50'}">
                                                <td class="border p-2 text-center text-xs font-bold text-gray-500">${i+1}</td>
                                                <td class="border p-2 font-bold text-gray-800 text-xs">${a.teacherName}</td>
                                                <td class="border p-2 text-center text-xs">${a.dayOfWeek}</td>
                                                <td class="border p-2 text-center text-xs text-gray-600">${a.date}</td>
                                                <td class="border p-2 text-center text-xs font-bold text-blue-600">${a.lessonTime || '-'}</td>
                                                <td class="border p-2 text-xs">${a.subject}</td>
                                                <td class="border p-2 text-xs">${a.activityName}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>`}
                                
                                <div class="mt-auto pt-8 border-t flex justify-between text-xs text-gray-500 font-bold px-4">
                                    <span>Ú˜Ù…Ø§Ø±Û•ÛŒ Ú†Ø§Ù„Ø§Ú©ÛŒ: ${sorted.length}</span>
                                    <span>ÙˆØ§Ú˜Û†ÛŒ Ø¨Û•Ú•ÛÙˆÛ•Ø¨Û•Ø±</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        function render() {
            const app = document.getElementById('app');
            let content = '';

            if (state.showReportModal) content = ReportModal();
            else if (state.showMonthModal) content = MonthModal();
            else {
                content = Header() + Navigation();
                if (state.currentView === 'admin') content += AdminView();
                else content += TeacherView();
            }

            app.innerHTML = content;
            applyTheme();
        }

        // INIT
        applyTheme();
        loadActivities();
        window.addEventListener('online', () => updateStatus('online'));
        window.addEventListener('offline', () => updateStatus('offline'));

    </script>
</body>
</html>
